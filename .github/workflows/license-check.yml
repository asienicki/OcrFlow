name: License check

on:
  push:
    branches: [ "main", "feat/**" ]
  pull_request:
  workflow_dispatch:

jobs:
  license-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore

      - name: Export dependency list
        run: |
          dotnet list package \
            --include-transitive \
            --format json > packages.json

      - name: Setup yq
        uses: mikefarah/yq@v4

      - name: License check (NuGet nuspec, safe)
        shell: bash
        run: |
          set -euo pipefail

          ALLOWED=$(yq -r '.whitelist[]' licenses/policy.yml)
          FORBIDDEN=$(yq -r '.blacklist[]' licenses/policy.yml)

          mkdir -p .licenses/tmp
          FAIL=0

          normalize() {
            echo "$1" | sed -E '
              s#https://licenses\.nuget\.org/MIT#MIT#I;
              s#https://licenses\.nuget\.org/Apache-2\.0#Apache-2.0#I;
              s#https://licenses\.nuget\.org/BSD-3-Clause#BSD-3-Clause#I;
              s#https://licenses\.nuget\.org/BSD-2-Clause#BSD-2-Clause#I;
              s/ License//I;
              s/^Apache License 2.0$/Apache-2.0/I;
            '
          }

          while IFS=$'\t' read -r NAME VERSION; do
            echo "→ $NAME $VERSION"

            NUPKG=".licenses/$NAME.$VERSION.nupkg"
            TMP=".licenses/tmp/$NAME.$VERSION"
            mkdir -p "$TMP"

            URL="https://api.nuget.org/v3-flatcontainer/${NAME,,}/$VERSION/${NAME,,}.$VERSION.nupkg"

            if ! curl -fsSL "$URL" -o "$NUPKG"; then
              LICENSE="UNKNOWN"
            else
              unzip -qq -o "$NUPKG" '*.nuspec' -d "$TMP"
              NUSPEC=$(ls "$TMP"/*.nuspec 2>/dev/null | head -n 1)

              if [[ -z "${NUSPEC:-}" ]]; then
                LICENSE="UNKNOWN"
              else
                LICENSE=$(sed -nE 's:.*<(licenseExpression|license)>([^<]+)<.*:\2:p' "$NUSPEC")
                [[ -z "$LICENSE" ]] && LICENSE=$(sed -nE 's:.*<licenseUrl>([^<]+)<.*:\1:p' "$NUSPEC")
                LICENSE=${LICENSE:-UNKNOWN}
              fi
            fi

            rm -rf "$TMP"

            LICENSE=$(normalize "$LICENSE")
            echo "   license: $LICENSE"

            if [[ "$LICENSE" == "UNKNOWN" ]]; then
              echo "::warning::⚠️ $NAME $VERSION has UNKNOWN license"
              continue
            fi

            if echo "$FORBIDDEN" | grep -qx "$LICENSE"; then
              echo "::error::❌ $NAME uses forbidden license: $LICENSE"
              FAIL=1
            elif ! echo "$ALLOWED" | grep -qx "$LICENSE"; then
              echo "::error::❌ $NAME uses non-whitelisted license: $LICENSE"
              FAIL=1
            else
              echo "   ✅ allowed"
            fi
          done < <(
            jq -r '
              .projects[]?
              | .frameworks[]?
              | (.topLevelPackages[]?, .transitivePackages[]?)
              | [.id, .resolvedVersion] | @tsv
            ' packages.json | sort -u
          )

          exit $FAIL

      - name: Upload dependency inventory
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-inventory
          path: packages.json
