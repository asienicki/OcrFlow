name: License compliance check

on:
  push:
    branches: [ "main", "feat/**" ]
  pull_request:
  workflow_dispatch:

jobs:
  license-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Ensure tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip curl

      - name: Cache license artifacts
        uses: actions/cache@v4
        with:
          path: .licenses
          key: licenses-${{ runner.os }}-${{ hashFiles('licenses/policy.yml') }}

      - name: Restore
        run: dotnet restore

      - name: Export dependency list
        run: |
          dotnet list package \
            --include-transitive \
            --format json > packages.json

      - name: Setup yq
        uses: mikefarah/yq@v4

      - name: License compliance check (NuGet nuspec)
        shell: bash
        run: |
          set -euo pipefail

          WHITELIST=$(yq -r '.whitelist[]' licenses/policy.yml)
          WARNLIST=$(yq -r '.warnlist[]' licenses/policy.yml)
          BLACKLIST=$(yq -r '.blacklist[]' licenses/policy.yml)

          mkdir -p .licenses/tmp
          FAIL=0

          normalize() {
            echo "$1" | sed -E '
              s#https://licenses\.nuget\.org/MIT#MIT#I;
              s#https://licenses\.nuget\.org/Apache-2\.0#Apache-2.0#I;
              s#https://licenses\.nuget\.org/BSD-3-Clause#BSD-3-Clause#I;
              s#https://licenses\.nuget\.org/BSD-2-Clause#BSD-2-Clause#I;
              s#https://aka.ms/deprecateLicenseUrl#DEPRECATED_LICENSE_URL#I;
              s/ License//I;
              s/^Apache License 2.0$/Apache-2.0/I;
            ' | xargs
          }

          is_exception() {
            local name=$1
            local version=$2
            yq -e ".exceptions.\"$name\" and .exceptions.\"$name\".version == \"$version\"" \
              licenses/policy.yml > /dev/null 2>&1
          }

          while IFS=$'\t' read -r NAME VERSION; do
            echo "→ $NAME $VERSION"

            # --- EXCEPTION (package + version) ---
            if is_exception "$NAME" "$VERSION"; then
              EX_LICENSE=$(yq -r ".exceptions.\"$NAME\".license" licenses/policy.yml)
              EX_LICENSE=$(normalize "$EX_LICENSE")

              if echo "$BLACKLIST" | grep -qx "$EX_LICENSE"; then
                echo "::error::Exception violates blacklist: $NAME $VERSION ($EX_LICENSE)"
                FAIL=1
              else
                echo "::notice::Exception applied for $NAME $VERSION ($EX_LICENSE)"
              fi
              continue
            fi

            # --- FETCH NUSPEC ---
            NUPKG=".licenses/$NAME.$VERSION.nupkg"
            TMP=".licenses/tmp/$NAME.$VERSION"
            mkdir -p "$TMP"

            URL="https://api.nuget.org/v3-flatcontainer/${NAME,,}/$VERSION/${NAME,,}.$VERSION.nupkg"

            if ! curl -fsSL "$URL" -o "$NUPKG"; then
              LICENSE="UNKNOWN"
            else
              unzip -qq -o "$NUPKG" '*.nuspec' -d "$TMP"
              NUSPEC=$(ls "$TMP"/*.nuspec 2>/dev/null | head -n 1)

              if [[ -z "${NUSPEC:-}" ]]; then
                LICENSE="UNKNOWN"
              else
                LICENSE=$(sed -nE 's:.*<(licenseExpression|license)>([^<]+)<.*:\2:p' "$NUSPEC")
                [[ -z "$LICENSE" ]] && LICENSE=$(sed -nE 's:.*<licenseUrl>([^<]+)<.*:\1:p' "$NUSPEC")
                LICENSE=${LICENSE:-UNKNOWN}
              fi
            fi

            rm -rf "$TMP"
            LICENSE=$(normalize "$LICENSE")
            echo "   license: $LICENSE"

            # --- CLASSIFICATION ---
            if [[ "$LICENSE" == "DEPRECATED_LICENSE_URL" ]]; then
              echo "::error::Unclassified dependency – deprecated licenseUrl used: $NAME $VERSION"
              FAIL=1
              continue
            fi

            if [[ "$LICENSE" == "UNKNOWN" ]]; then
              echo "::error::Unclassified dependency – missing license: $NAME $VERSION"
              FAIL=1
              continue
            fi

            if echo "$BLACKLIST" | grep -qx "$LICENSE"; then
              echo "::error::Disallowed license detected: $NAME ($LICENSE)"
              FAIL=1
            elif echo "$WARNLIST" | grep -qx "$LICENSE"; then
              echo "::warning::Conditionally allowed license: $NAME ($LICENSE)"
            elif ! echo "$WHITELIST" | grep -qx "$LICENSE"; then
              echo "::error::Non-compliant license (not classified): $NAME ($LICENSE)"
              FAIL=1
            else
              echo "   ✅ compliant"
            fi

          done < <(
            jq -r '
              .projects[]?
              | .frameworks[]?
              | (.topLevelPackages[]?, .transitivePackages[]?)
              | [.id, .resolvedVersion] | @tsv
            ' packages.json | sort -u
          )

          exit $FAIL

      - name: Upload dependency inventory
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-inventory
          path: packages.json
