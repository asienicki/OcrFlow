name: License check

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  licenses:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Install dotnet-project-licenses
        run: dotnet tool install --global dotnet-project-licenses --version 2.7.1

      - name: Enable yq
        uses: mikefarah/yq@v4

      # === HARD RULES ===
      # GREEN      -> whitelist
      # RED        -> blacklist
      # TURBO RED  -> missing / unknown license
      - name: License check (hard rules)
        run: |
          ALLOWED=$(yq '.whitelist[]' licenses/policy.yml | tr '\n' ' ')
          FORBIDDEN=$(yq '.blacklist[]' licenses/policy.yml | tr '\n' ' ')

          dotnet-project-licenses \
            --input . \
            --allowed-license-types $ALLOWED \
            --forbidden-license-types $FORBIDDEN \
            --fail-on-missing-l
