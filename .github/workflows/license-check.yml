name: License check

on:
  push:
    branches: [ "main", "feat/**" ]
  pull_request:
  workflow_dispatch:

jobs:
  license-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore

      - name: Export packages (with licenses)
        run: |
          dotnet list package \
            --include-transitive \
            --format json > packages.json

      - name: Setup yq
        uses: mikefarah/yq@v4

      - name: License policy check
        shell: bash
        run: |
          set -euo pipefail

          ALLOWED=$(yq -r '.whitelist[]' licenses/policy.yml)
          FORBIDDEN=$(yq -r '.blacklist[]' licenses/policy.yml)

          echo "Allowed:"
          echo "$ALLOWED"
          echo
          echo "Forbidden:"
          echo "$FORBIDDEN"
          echo

          FAIL=0

          while IFS=$'\t' read -r NAME LICENSE; do
            echo "→ $NAME | $LICENSE"

            if [[ "$LICENSE" == "UNKNOWN" ]]; then
              echo "::error::❌ $NAME has UNKNOWN license"
              FAIL=1
              continue
            fi

            if echo "$FORBIDDEN" | grep -qx "$LICENSE"; then
              echo "::error::❌ $NAME uses forbidden license: $LICENSE"
              FAIL=1
            elif echo "$ALLOWED" | grep -qx "$LICENSE"; then
              echo "✅ $NAME ($LICENSE)"
            else
              echo "::error::❌ $NAME uses non-whitelisted license: $LICENSE"
              FAIL=1
            fi
          done < <(
            jq -r '
              .projects[]?
              | .frameworks[]?
              | .dependencies[]?
              | [.name, (.license // "UNKNOWN")] | @tsv
            ' packages.json | sort -u
          )

          exit $FAIL

      - name: Upload license report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: packages.json
