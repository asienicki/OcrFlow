name: License compliance check

on:
  push:
    branches: [ "main", "feat/**" ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  license-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Ensure tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip curl gh

      - name: Cache license artifacts
        uses: actions/cache@v4
        with:
          path: .licenses
          key: licenses-${{ runner.os }}-${{ hashFiles('licenses/policy.yml') }}

      - name: Restore
        run: dotnet restore

      - name: Export dependency list
        run: |
          dotnet list package \
            --include-transitive \
            --format json > packages.json

      - name: Setup yq
        uses: mikefarah/yq@v4

      - name: License compliance check (NuGet nuspec)
        shell: bash
        run: |
          set -euo pipefail

          WHITELIST=$(yq -r '.whitelist[]' licenses/policy.yml)
          WARNLIST=$(yq -r '.warnlist[]' licenses/policy.yml)
          BLACKLIST=$(yq -r '.blacklist[]' licenses/policy.yml)

          mkdir -p .licenses/tmp
          RESULTS=".licenses/results.tsv"
          > "$RESULTS"

          FAIL=0

          normalize() {
            echo "$1" | sed -E '
              s#https://licenses\.nuget\.org/MIT#MIT#I;
              s#https://licenses\.nuget\.org/Apache-2\.0#Apache-2.0#I;
              s#https://licenses\.nuget\.org/BSD-3-Clause#BSD-3-Clause#I;
              s#https://licenses\.nuget\.org/BSD-2-Clause#BSD-2-Clause#I;
              s#https://aka.ms/deprecateLicenseUrl#DEPRECATED_LICENSE_URL#I;
              s/ License//I;
              s/^Apache License 2.0$/Apache-2.0/I;
            ' | xargs
          }

          is_exception() {
            yq -e ".exceptions.\"$1\" and .exceptions.\"$1\".version == \"$2\"" \
              licenses/policy.yml > /dev/null 2>&1
          }

          while IFS=$'\t' read -r NAME VERSION; do
            STATUS=""
            LICENSE=""

            # --- EXCEPTION (package + version) ---
            if is_exception "$NAME" "$VERSION"; then
              LICENSE=$(yq -r ".exceptions.\"$NAME\".license" licenses/policy.yml)
              LICENSE=$(normalize "$LICENSE")

              if echo "$BLACKLIST" | grep -qx "$LICENSE"; then
                STATUS="DISALLOWED"
                FAIL=1
              else
                STATUS="EXCEPTION"
              fi

              echo -e "$NAME\t$VERSION\t$LICENSE\t$STATUS" >> "$RESULTS"
              continue
            fi

            # --- FETCH NUSPEC ---
            URL="https://api.nuget.org/v3-flatcontainer/${NAME,,}/$VERSION/${NAME,,}.$VERSION.nupkg"
            TMP=".licenses/tmp/$NAME.$VERSION"
            mkdir -p "$TMP"

            if curl -fsSL "$URL" -o "$TMP/pkg.nupkg"; then
              unzip -qq -o "$TMP/pkg.nupkg" '*.nuspec' -d "$TMP"
              NUSPEC=$(ls "$TMP"/*.nuspec 2>/dev/null | head -n 1)
              LICENSE=$(sed -nE 's:.*<(licenseExpression|license)>([^<]+)<.*:\2:p' "$NUSPEC")
              [[ -z "$LICENSE" ]] && LICENSE=$(sed -nE 's:.*<licenseUrl>([^<]+)<.*:\1:p' "$NUSPEC")
            fi

            rm -rf "$TMP"
            LICENSE=$(normalize "${LICENSE:-UNKNOWN}")

            # --- CLASSIFICATION ---
            if [[ "$LICENSE" == "DEPRECATED_LICENSE_URL" || "$LICENSE" == "UNKNOWN" ]]; then
              STATUS="UNCLASSIFIED"
              FAIL=1
            elif echo "$BLACKLIST" | grep -qx "$LICENSE"; then
              STATUS="DISALLOWED"
              FAIL=1
            elif echo "$WARNLIST" | grep -qx "$LICENSE"; then
              STATUS="CONDITIONALLY_ALLOWED"
            elif echo "$WHITELIST" | grep -qx "$LICENSE"; then
              STATUS="COMPLIANT"
            else
              STATUS="UNCLASSIFIED"
              FAIL=1
            fi

            echo -e "$NAME\t$VERSION\t$LICENSE\t$STATUS" >> "$RESULTS"

          done < <(
            jq -r '
              .projects[]?
              | .frameworks[]?
              | (.topLevelPackages[]?, .transitivePackages[]?)
              | [.id, .resolvedVersion] | @tsv
            ' packages.json | sort -u
          )

          exit $FAIL

      - name: Comment license compliance summary on PR
        if: github.event_name == 'pull_request'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RESULTS=".licenses/results.tsv"

          {
            echo "## ðŸ“œ License Compliance Report"
            echo ""
            echo "### âŒ Non-compliant / Unclassified"
            awk -F'\t' '$4=="DISALLOWED" || $4=="UNCLASSIFIED" {printf "- **%s** %s â€” %s\n",$1,$2,$3}' "$RESULTS" || echo "- None"
            echo ""
            echo "### âš ï¸ Conditionally Allowed (review required)"
            awk -F'\t' '$4=="CONDITIONALLY_ALLOWED" {printf "- **%s** %s â€” %s\n",$1,$2,$3}' "$RESULTS" || echo "- None"
            echo ""
            echo "### âœ… Summary (by license)"
            awk -F'\t' '{print $3}' "$RESULTS" | sort | uniq -c | sort -nr \
              | awk '{printf "- **%s**: %s dependencies\n",$2,$1}'
          } > comment.md

          gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            -f body="$(cat comment.md)"
