name: License check

on:
  push:
    branches: [ "main", "feat/**" ]
  pull_request:
  workflow_dispatch:

jobs:
  license-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore

      - name: Export dependency list
        run: |
          dotnet list package \
            --include-transitive \
            --format json > packages.json

      - name: Setup yq
        uses: mikefarah/yq@v4

      - name: License check (NuGet nuspec)
        shell: bash
        run: |
          set -euo pipefail

          ALLOWED=$(yq -r '.whitelist[]' licenses/policy.yml)
          FORBIDDEN=$(yq -r '.blacklist[]' licenses/policy.yml)

          mkdir -p .licenses
          FAIL=0

          jq -r '
            .projects[]?
            | .frameworks[]?
            | (.topLevelPackages[]?, .transitivePackages[]?)
            | [.id, .resolvedVersion] | @tsv
          ' packages.json | sort -u | while IFS=$'\t' read -r NAME VERSION; do

            echo "→ $NAME $VERSION"

            NUPKG=".licenses/$NAME.$VERSION.nupkg"
            URL="https://api.nuget.org/v3-flatcontainer/${NAME,,}/$VERSION/${NAME,,}.$VERSION.nupkg"

            if ! curl -fsSL "$URL" -o "$NUPKG"; then
              echo "::error::❌ cannot download $NAME $VERSION"
              FAIL=1
              continue
            fi

            unzip -qq -o "$NUPKG" '*.nuspec' -d .licenses

            NUSPEC=$(find .licenses -name '*.nuspec' | head -n 1)

            LICENSE=$(
              xmllint --xpath \
              'string(//license | //licenseExpression | //licenseUrl)' \
              "$NUSPEC" 2>/dev/null || echo "UNKNOWN"
            )

            rm -f "$NUSPEC"

            echo "   license: $LICENSE"

            if [[ "$LICENSE" == "UNKNOWN" || -z "$LICENSE" ]]; then
              echo "::error::❌ $NAME has UNKNOWN license"
              FAIL=1
              continue
            fi

            if echo "$FORBIDDEN" | grep -qx "$LICENSE"; then
              echo "::error::❌ $NAME uses forbidden license: $LICENSE"
              FAIL=1
            elif echo "$ALLOWED" | grep -qx "$LICENSE"; then
              echo "   ✅ allowed"
            else
              echo "::error::❌ $NAME uses non-whitelisted license: $LICENSE"
              FAIL=1
            fi
          done

          exit $FAIL

      - name: Upload dependency inventory
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-inventory
          path: packages.json
